// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id                    String    @id @default(cuid())
  email                 String?   @unique
  walletAddress         String?   @unique
  name                  String?
  avatar                String?
  biologicalAge         Float?
  stakedTokens          Float     @default(0)
  totalTokensEarned     Float     @default(0)
  preferences           Json?     // Food preferences, dietary restrictions, etc.
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  auth                  UserAuth?
  sessions              UserSession[]
  wearableConnections   WearableConnection[]
  biomarkerReadings     BiomarkerReading[]
  biologicalAges        BiologicalAge[]
  protocolExperiments   ProtocolExperiment[]
  desciContributions    DeSciContribution[]
  advancedMetrics       AdvancedMetric[]
  mealLogs              MealLog[]
  medicalResults        MedicalResult[]
  longevityPlans        LongevityPlan[]
  achievements          Achievement[]
  stakings              Staking[]
  leaderboardEntries    Leaderboard[]

  @@index([walletAddress])
  @@index([email])
}

model UserAuth {
  id                    String    @id @default(cuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  passwordHash          String
  passwordResetToken    String?
  passwordResetExpires  DateTime?
  twoFactorEnabled      Boolean   @default(false)
  twoFactorSecret       String?
  twoFactorBackupCodes  String[]
  loginAttempts         Int       @default(0)
  lockUntil             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model UserSession {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionToken    String    @unique
  refreshToken    String?   @unique
  walletAddress   String?
  loginTimestamp  DateTime  @default(now())
  expiryTimestamp DateTime
  lastActivity    DateTime  @default(now())
  deviceInfo      Json?
  ipAddress       String?
  userAgent       String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([sessionToken])
}

// ==========================================
// WEARABLES & BIOMETRICS
// ==========================================

model WearableConnection {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider      String   // "oura", "apple", "google", "whoop", "strava", "fitbit"
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  expiresAt     DateTime?
  lastSyncAt    DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId, provider])
}

model BiomarkerReading {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metric        String   // "hrv", "sleep_score", "readiness", "strain", etc.
  value         Float
  unit          String   // "ms", "%", "score"
  source        String   // "oura", "apple", "google", "whoop", "strava", "fitbit"
  date          DateTime
  metadata      Json?    // Additional data (sleep phases, HR zones, etc.)
  createdAt     DateTime @default(now())
  
  @@index([userId, metric, date])
}

model BiologicalAge {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chronologicalAge  Int
  biologicalAge     Float
  cardiacAge        Float?   // HRV-based
  sleepAge          Float?   // Sleep quality-based
  activityAge       Float?   // Movement-based
  recoveryAge       Float?   // Recovery-based
  calculatedAt      DateTime @default(now())
  factors           Json?    // What's driving the score

  @@index([userId, calculatedAt])
}

model AdvancedMetric {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metricType    String   // "hrv_coherence", "sleep_debt", "parasympathetic_tone", etc.
  value         Float
  date          DateTime
  calculatedAt  DateTime @default(now())

  @@index([userId, metricType, date])
}

// ==========================================
// PROTOCOLS & EXPERIMENTS
// ==========================================

model ProtocolExperiment {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String   // "cold_plunge", "meditation", "fasting", etc.
  startDate         DateTime
  endDate           DateTime?
  status            String   // "active", "completed", "paused"
  notes             String?  @db.Text
  correlatedMetrics Json?    // { "hrv": 8, "sleep": 12 }
  adherence         Float?   // 0-100%
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId, status])
}

// ==========================================
// FOOD & NUTRITION
// ==========================================

model MealLog {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  photoUrl        String?  // Food photo
  aiIdentified    Json?    // AI food identification results
  foods           Json     // Array of foods with portions
  calories        Float
  protein         Float
  carbs           Float
  fat             Float
  micronutrients  Json?    // Omega-3, polyphenols, NAD+ boosters, etc.
  mealType        String   // "breakfast", "lunch", "dinner", "snack"
  date            DateTime
  createdAt       DateTime @default(now())
  
  @@index([userId, date])
}

// ==========================================
// MEDICAL RESULTS
// ==========================================

model MedicalResult {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pdfUrl          String?  // Uploaded PDF/image
  extractedData   Json     // AI-extracted biomarkers
  biomarkers      Json     // Structured biomarker data
  testDate        DateTime
  testType        String   // "blood", "hormone", "metabolic", etc.
  labName         String?
  doctorNotes     String?  @db.Text
  flags           Json?    // Red/yellow/green flags
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, testDate])
}

// ==========================================
// AI LONGEVITY PLANS
// ==========================================

model LongevityPlan {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planType        String   // "nutrition", "exercise", "sleep", "supplements", "stress", "combined"
  recommendations Json     // Structured recommendations
  mealPlan        Json?    // 30-day meal plan
  exercisePlan    Json?    // Workout schedule
  supplementStack Json?   // Supplement recommendations
  expectedResults Json?    // Expected improvements
  startDate       DateTime
  endDate         DateTime?
  status          String   // "active", "completed", "paused"
  adherence       Float?   // 0-100%
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, status])
}

// ==========================================
// DESCI & TOKEN REWARDS
// ==========================================

model DeSciContribution {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataPoints    Int
  tokenReward   Float    // $TA tokens earned
  researchStudy String?
  transactionHash String? // Blockchain transaction
  date          DateTime @default(now())

  @@index([userId, date])
}

// ==========================================
// GAMIFICATION
// ==========================================

model Achievement {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            String   // "sleep_optimizer", "hrv_master", "protocol_warrior", etc.
  unlockedAt      DateTime @default(now())
  tokenReward     Float    // $TA tokens earned
  badgeUrl        String?

  @@index([userId, type])
}

model Staking {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Float    // $TA tokens staked
  apy             Float    // Current APY (8-12%)
  rewardsEarned   Float    // Total rewards earned
  startDate       DateTime
  unlockDate      DateTime? // For locked staking
  status          String   // "active", "withdrawn"
  createdAt       DateTime @default(now())

  @@index([userId, status])
}

model Leaderboard {
  id              String   @id @default(cuid())
  competitionId   String
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metric          String   // "biological_age", "hrv", "sleep", etc.
  value           Float
  rank            Int
  period          String   // "daily", "weekly", "monthly"
  date            DateTime
  createdAt       DateTime @default(now())
  
  @@index([competitionId, rank])
}

// ==========================================
// LEGACY MODELS (for backward compatibility)
// ==========================================

model HealthData {
  id          String   @id @default(cuid())
  userId      String
  type        String
  value       Float
  unit        String?
  notes       String?  @db.Text
  source      String?
  recordedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, recordedAt])
}

model HealthScore {
  id          String   @id @default(cuid())
  userId      String
  score       Float
  factors     Json?
  calculatedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, calculatedAt])
}
